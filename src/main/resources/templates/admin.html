
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>

    <title>Users</title>
</head>
<body>
<nav class="navbar navbar-dark bg-dark p-0">
    <div class="container-fluid m-2">
        <a class="navbar-brand col-lg-10 col-sm-3 col-md-2 mr-0" href="#" style="margin-left: 27px;"
           th:text="${user.email + ' WITH ROLES ' + user.getShortRoles()}"></a>
        <ul class="navbar-nav px-4">
            <li class="nav-item">
                <form action="/logout" method="get">
                    <button type="submit" class="btn   navbar-btn navbar-link bg-dark text-white-50">
                        Logout
                    </button>
                </form>
            </li>
        </ul>
    </div>
</nav>


<div class="container-fluid" style="height: 1000px">
    <div class="row" style="height: inherit"><br>
        <nav class="col-2 nav flex-column nav-pills text-center">
            <a class="nav-link active text-white" th:if="${#request.isUserInRole('ROLE_ADMIN')}" th:href="@{/admin}">Admin</a>
            <a class="nav-link" th:href="@{/user/{id} (id=${user.getId()})}">User</a>
        </nav>
        <div class="col-10 bg-light">
            <h1 class="text-left">Admin panel</h1>
            <nav>
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#table_users">Users table</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#new_user">New User</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active border" id="table_users">
                        <div class="card">
                            <div class="card-header text-left"><h4>All users</h4></div>
                            <div class="card-body">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Edit</th>
                                        <th>Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody class="usersList"></tbody>
                                </table>

                                <div class="modal fade" id="editModal" tabindex="-1" role="dialog"
                                     aria-labelledby="editModalLabel">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="editModalLabel">Edit user: </h4>
                                                <button type="button" class="close" data-bs-dismiss="modal"
                                                        aria-label="Close"><span aria-hidden="true">x</span>
                                                </button>
                                            </div>
                                            <div class="modal-body form-group">
                                                <form class="text-center fw-bold" id="editForm" th:method="PUT">
                                                    <div class="row">
                                                        <div class="col-md-3"></div>
                                                        <div class="col-md-6">
                                                            <label for="edit_id_input">ID: </label>
                                                            <input type="text" readonly id="edit_id_input" name="id"
                                                                   class="form-control"/>

                                                            <label for="edit_username_input">Username: </label>
                                                            <input type="text" id="edit_username_input"
                                                                   name="username" class="form-control"/>

                                                            <label for="edit_email_input">Email: </label>
                                                            <input type="text" id="edit_email_input" name="email"
                                                                   class="form-control"/>

                                                            <label for="edit_password_input">Password: </label>
                                                            <input type="password" id="edit_password_input"
                                                                   name="password" class="form-control"/>

                                                            <label for="edit_roles_select">Roles: </label>
                                                            <select multiple size="2" class="form-control"
                                                                    id="edit_roles_select"></select><br>

                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Close
                                                                </button>
                                                                <button type="submit"
                                                                        class="btn btn-primary editUserButton">Edit
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog"
                                     aria-labelledby="deleteModalLabel">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="deleteModalLabel">Delete user</h4>
                                                <button type="button" class="close text-right" data-bs-dismiss="modal"
                                                        aria-label="Close"><span aria-hidden="true">x</span></button>
                                            </div>
                                            <div class="modal-body form-group">
                                                <form class="text-center fw-bold">
                                                    <div class="row">
                                                        <div class="col-md-3"></div>
                                                        <div class="col-md-6">
                                                            <label for="delete_id_input">ID: </label>
                                                            <input type="text" id="delete_id_input" class="form-control"
                                                                   name="id" disabled/>

                                                            <label for="delete_username_input">Username: </label>
                                                            <input type="text" id="delete_username_input"
                                                                   class="form-control" disabled/>

                                                            <label for="delete_email_input">Email: </label>
                                                            <input type="text" id="delete_email_input"
                                                                   class="form-control" disabled/>

                                                            <label for="delete_roles-select">Roles: </label>
                                                            <select multiple size="2" class="form-control"
                                                                    id="delete_roles-select" disabled>
                                                            </select><br>

                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Close
                                                                </button>
                                                                <button type="submit"
                                                                        class="btn btn-danger btn-primary deleteUserButton">
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane container-fluid fade" id="new_user">
                        <div class="row">
                            <div class="col-4"></div>
                            <div class="col-5">
                                <form class="text-center font-weight-bold addUserForm" role="form">
                                    <div class="form-group">
                                        <label for="username_input" class="control-label">Username</label>
                                        <input type="text" id="username_input" class="form-control"
                                               placeholder="username...">
                                    </div>

                                    <div class="form-group">
                                        <label for="email_input" class="control-label">Email</label>
                                        <input type="text" id="email_input" class="form-control"
                                               placeholder="example@mail.ru">
                                    </div>

                                    <div class="form-group">
                                        <label for="password_input" class="control-label">Password</label>
                                        <input type="text" id="password_input" class="form-control"
                                               placeholder="password...">
                                    </div>

                                    <div class="form-group">
                                        <label for="roles">Roles</label>
                                        <select multiple size="2" class="form-control" id="roles"></select>
                                    </div>
                                    <br>
                                    <div class="justify-content-center d-flex">
                                        <input type="submit" class="btn btn-success" value="Add new user" id="addUser"/><br><br>
                                    </div>
                                </form>
                            </div>
                            <div class="col-4"></div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</div>
<script type="text/javascript" th:src="@{fetchApp.js}"></script>
<!--<script type="text/javascript">-->
<!--    const url = 'http://localhost:8189/api/users'-->
<!--    const urlRoles = 'http://localhost:8189/api/roles'-->

<!--    let  usersList = document.querySelector('.usersList')-->
<!--    let  result = ''-->

<!--    getUsers()-->

<!--    function getUsers() {-->
<!--        fetch(url).then(response => response.json())-->
<!--            .then(data => {drawTable(data)})-->
<!--            .catch(err => console.log(err))-->
<!--    }-->

<!--    const drawTable = (users) => {-->
<!--        usersList.innerHTML = ''-->
<!--        result = ''-->
<!--        users.forEach(user => {-->
<!--            let userRoles = ``-->
<!--            for (let role of user.roles) {-->
<!--                userRoles += role.name.replace("ROLE_", "") + ' '-->
<!--            }-->
<!--            result += `<tr>-->
<!--                    <td>${user.id}</td>-->
<!--                    <td>${user.username}</td>-->
<!--                    <td>${user.email}</td>-->
<!--                    <td>${userRoles}</td>-->
<!--                    <td><button type="button" class="btn btn-info text-white editButton" data-bs-toggle="modal">Edit</button></td>-->
<!--                    <td><button type="button" class="btn btn-danger text-white deleteButton" data-bs-toggle="modal">Delete</button></td>-->
<!--                </tr>`-->
<!--        })-->
<!--        usersList.innerHTML = result-->
<!--    }-->

<!--    const on = (element, event, selector, handler) => {-->
<!--        element.addEventListener(event, e => {-->
<!--            if (e.target.closest(selector)) {-->
<!--                handler(e)-->
<!--            }-->
<!--        })-->
<!--    }-->

<!--    const editModal = new bootstrap.Modal(document.getElementById('editModal'))-->
<!--    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'))-->

<!--    on(document, 'click', '.editButton', e => {-->
<!--        const tableRow = e.target.parentNode.parentNode-->
<!--        let editIdForm = tableRow.children[0].innerHTML-->

<!--        fetch(url + '/' + editIdForm)-->
<!--            .then(res => res.json())-->
<!--            .then(data => showEditModal(data))-->
<!--    })-->

<!--    on(document, 'click', '.deleteButton', e => {-->
<!--        const tableRow = e.target.parentNode.parentNode-->
<!--        let deleteIdForm = tableRow.children[0].innerHTML-->

<!--        fetch(url + '/' + deleteIdForm)-->
<!--            .then(res => res.json())-->
<!--            .then(data => showDeleteModal(data))-->
<!--    })-->

<!--    //+++++++++++++++++++++++++++++++EDIT+++++++++++++++++++++++++++++++//-->
<!--    const showEditModal = (user) => {-->
<!--        const editId = document.getElementById('edit_id_input')-->
<!--        const editUsername = document.getElementById('edit_username_input')-->
<!--        const editEmail = document.getElementById('edit_email_input')-->
<!--        const editRoles = document.getElementById('edit_roles_select')-->

<!--        editId.value = user.id-->
<!--        editUsername.value = user.username-->
<!--        editEmail.value = user.email-->

<!--        while (editRoles.options.length) {-->
<!--            editRoles.options[0] = null;-->
<!--        }-->
<!--        fetch(urlRoles)-->
<!--            .then(res => res.json())-->
<!--            .then(roles => {-->
<!--                roles.forEach(role => {-->
<!--                    user.roles.forEach(userRole => {-->
<!--                        if (userRole.id === role.id) {-->
<!--                            editRoles.append(new Option(role.name.replace("ROLE_", ""), role.id, true, true));-->
<!--                            role = true;-->
<!--                        }-->
<!--                    });-->
<!--                    role !== true ? editRoles.append(new Option(role.name.replace("ROLE_", ""), role.id)) : null;-->
<!--                });-->
<!--            });-->

<!--        editModal.show()-->

<!--        const editUserButton = document.querySelector('.editUserButton')-->
<!--        editUserButton.addEventListener('click', e => {-->
<!--            e.preventDefault()-->

<!--            let rolesFromForm = document.getElementById('edit_roles_select')-->
<!--            let selectedOptions = rolesFromForm.selectedOptions-->
<!--            let selected = []-->
<!--            for (let i = 0; i < selectedOptions.length; i++) {-->
<!--                selected.push({id: selectedOptions[i].value, name: 'ROLE_' + selectedOptions[i].text})-->
<!--            }-->
<!--            let prevPass = user.password-->
<!--            let pass;-->
<!--            if (document.getElementById('edit_password_input').value === '') {-->
<!--                pass = prevPass-->
<!--            } else {-->
<!--                pass = document.getElementById('edit_password_input').value-->
<!--            }-->
<!--            let data = {-->
<!--                id: editId.value,-->
<!--                username: editUsername.value,-->
<!--                email: editEmail.value,-->
<!--                password: pass,-->
<!--                roles: selected-->
<!--            }-->
<!--            fetch(url, {-->
<!--                method: 'PUT',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify(data)-->
<!--            })-->
<!--                .then(getUsers)-->
<!--            editModal.hide()-->
<!--            document.getElementById('edit_password_input').value = ''-->
<!--        })-->
<!--    }-->
<!--    //+++++++++++++++++++++++++++++++EDIT+++++++++++++++++++++++++++++++//-->

<!--    //++++++++++++++++++++++++++++++DELETE++++++++++++++++++++++++++++++//-->
<!--    const showDeleteModal = (user) => {-->
<!--        const deleteId = document.getElementById('delete_id_input')-->
<!--        const deleteUsername = document.getElementById('delete_username_input')-->
<!--        const deleteEmail = document.getElementById('delete_email_input')-->
<!--        const deleteRoles = document.getElementById('delete_roles-select')-->

<!--        deleteId.value = user.id-->
<!--        deleteUsername.value = user.username-->
<!--        deleteEmail.value = user.email-->

<!--        while (deleteRoles.options.length) {-->
<!--            deleteRoles.options[0] = null-->
<!--        }-->
<!--        fetch(urlRoles)-->
<!--            .then(res => res.json())-->
<!--            .then(roles => {-->
<!--                roles.forEach(role => {-->
<!--                    user.roles.forEach(userRole => {-->
<!--                        if (userRole.id === role.id) {-->
<!--                            deleteRoles.append(new Option(role.name.replace("ROLE_", ""), role.id, true, true))-->
<!--                            role = true-->
<!--                        }-->
<!--                    });-->
<!--                    role !== true ? deleteRoles.append(new Option(role.name.replace("ROLE_", ""), role.id)) : null-->
<!--                })-->
<!--            })-->

<!--        deleteModal.show()-->

<!--        const deleteUserButton = document.querySelector('.deleteUserButton')-->
<!--        deleteUserButton.addEventListener('click', e => {-->
<!--            e.preventDefault()-->
<!--            fetch(url + '/' + user.id, {method: 'DELETE'})-->
<!--                .then(getUsers)-->
<!--            deleteModal.hide()-->
<!--        })-->
<!--    }-->
<!--    //++++++++++++++++++++++++++++++DELETE++++++++++++++++++++++++++++++//-->

<!--    //+++++++++++++++++++++++++++++++ADD++++++++++++++++++++++++++++++++//-->
<!--    const username = document.getElementById('username_input')-->
<!--    const email = document.getElementById('email_input')-->
<!--    const password = document.getElementById('password_input')-->
<!--    const formRoles = document.getElementById('roles')-->

<!--    fetch(urlRoles)-->
<!--        .then(res => res.json())-->
<!--        .then(roles => {-->
<!--            roles.forEach(role => {-->
<!--                formRoles.append(new Option(role.name.replace("ROLE_", ""), role.id + ''))-->
<!--            })-->
<!--        })-->

<!--    const addUserButton = document.querySelector('#addUser')-->
<!--    addUserButton.addEventListener('click', e => {-->
<!--        e.preventDefault()-->
<!--        let rolesFromForm = document.getElementById('roles')-->
<!--        let selectedOptions = rolesFromForm.selectedOptions-->
<!--        let selected = []-->
<!--        for (let i = 0; i < selectedOptions.length; i++) {-->
<!--            selected.push({id: selectedOptions[i].value, name: 'ROLE_' + selectedOptions[i].text})-->
<!--        }-->

<!--        let data = JSON.stringify({-->
<!--            username: username.value,-->
<!--            email: email.value,-->
<!--            password: password.value,-->
<!--            roles: selected-->
<!--        })-->

<!--        fetch(url, {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--                'Content-Type': 'application/json'-->
<!--            },-->
<!--            body: data-->
<!--        })-->
<!--            .then(getUsers)-->

<!--        username.value = ''-->
<!--        email.value = ''-->
<!--        password.value = ''-->
<!--        formRoles.value = ''-->
<!--    })-->
<!--    //+++++++++++++++++++++++++++++++ADD++++++++++++++++++++++++++++++++//-->
<!--</script>-->
</body>
</html>

